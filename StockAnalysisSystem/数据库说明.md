# 数据库说明

## 📊 数据库创建情况

### ✅ 代码会自动创建数据库

**是的，代码已经包含了自动创建数据库的功能！**

在 `Data/StockRepository.cs` 文件中的 `InitializeDatabase()` 方法会自动：

1. **创建数据库**（如果不存在）
   - 数据库名称：`StockAnalysisDB`
   - 在首次运行程序时自动创建

2. **创建数据表**（如果不存在）
   - `Favorites` - 收藏股票表
   - `RecentStocks` - 最近查询表
   - `StockData` - 股票历史数据表

### 🔄 创建时机

- 当 `StockRepository` 类首次被实例化时
- 也就是程序启动时
- 如果数据库已存在，不会重复创建（使用 `IF NOT EXISTS` 检查）

---

## 💾 数据库保存位置

### SQL Server 数据库位置

数据库文件保存在 **SQL Server 的数据目录**中，具体位置取决于你的 SQL Server 安装：

#### 1. SQL Server Express / 完整版

**默认位置**：
```
C:\Program Files\Microsoft SQL Server\MSSQL15.MSSQLSERVER\MSSQL\DATA\
```

**数据库文件**：
- `StockAnalysisDB.mdf` - 主数据文件
- `StockAnalysisDB_log.ldf` - 日志文件

#### 2. LocalDB（Visual Studio 自带）

**默认位置**：
```
C:\Users\<你的用户名>\StockAnalysisDB.mdf
```
或
```
C:\Users\<你的用户名>\AppData\Local\Microsoft\Microsoft SQL Server Local DB\Instances\MSSQLLocalDB\
```

#### 3. 命名实例

如果你安装了命名实例（如 SQLEXPRESS），路径可能是：
```
C:\Program Files\Microsoft SQL Server\MSSQL15.SQLEXPRESS\MSSQL\DATA\
```

---

## 🔍 如何查找数据库文件位置

### 方法 1：使用 SQL Server Management Studio (SSMS)

1. 打开 SSMS
2. 连接到 SQL Server 实例
3. 展开数据库节点
4. 右键点击 `StockAnalysisDB` → 属性
5. 查看"文件"页面，可以看到文件路径

### 方法 2：使用 SQL 查询

```sql
USE StockAnalysisDB;
GO

SELECT 
    name AS [数据库文件],
    physical_name AS [文件路径],
    size AS [文件大小(KB)],
    type_desc AS [文件类型]
FROM sys.database_files;
```

### 方法 3：使用 PowerShell 查找

```powershell
# 查找所有 .mdf 文件
Get-ChildItem -Path "C:\Program Files\Microsoft SQL Server" -Filter "*.mdf" -Recurse -ErrorAction SilentlyContinue | Where-Object { $_.Name -like "*StockAnalysis*" }
```

---

## 🔗 当前连接配置

查看 `Data/StockRepository.cs` 第 17 行：

```csharp
_connectionString = "Server=localhost;Database=StockAnalysisDB;User Id=sa;Password=YourPassword;TrustServerCertificate=True;";
```

### 配置说明

- **Server=localhost** - 连接到本地的 SQL Server
- **Database=StockAnalysisDB** - 数据库名称
- **User Id=sa** - SQL Server 身份验证（需要修改密码）
- **Password=YourPassword** - 需要替换为实际密码

### ⚠️ 重要提示

**当前配置使用的是 SQL Server 身份验证**，需要：

1. **修改密码**：
   - 将 `Password=YourPassword` 改为你的实际 SQL Server sa 密码

2. **或者使用 Windows 身份验证**：
   ```csharp
   _connectionString = "Server=localhost;Database=StockAnalysisDB;Integrated Security=True;TrustServerCertificate=True;";
   ```

---

## 📋 数据库结构

### Favorites（收藏表）

| 列名 | 类型 | 说明 |
|------|------|------|
| Id | INT | 主键，自增 |
| StockCode | NVARCHAR(50) | 股票代码 |
| StockName | NVARCHAR(200) | 股票名称 |
| CreatedDate | DATETIME | 创建时间 |

### RecentStocks（最近查询表）

| 列名 | 类型 | 说明 |
|------|------|------|
| Id | INT | 主键，自增 |
| StockCode | NVARCHAR(50) | 股票代码 |
| StockName | NVARCHAR(200) | 股票名称 |
| QueryDate | DATETIME | 查询时间 |

### StockData（股票数据表）

| 列名 | 类型 | 说明 |
|------|------|------|
| Id | INT | 主键，自增 |
| StockCode | NVARCHAR(50) | 股票代码 |
| StockName | NVARCHAR(200) | 股票名称 |
| Price | DECIMAL(18,2) | 价格 |
| ChangePercent | DECIMAL(18,2) | 涨跌幅 |
| Volume | BIGINT | 成交量 |
| OpenPrice | DECIMAL(18,2) | 开盘价 |
| HighPrice | DECIMAL(18,2) | 最高价 |
| LowPrice | DECIMAL(18,2) | 最低价 |
| ClosePrice | DECIMAL(18,2) | 收盘价 |
| UpdateTime | DATETIME | 更新时间 |

---

## ✅ 验证数据库是否创建成功

### 方法 1：运行程序

1. 启动应用程序
2. 查看是否有错误提示
3. 如果连接成功，数据库会自动创建

### 方法 2：使用 SSMS 查看

1. 打开 SQL Server Management Studio
2. 连接到 localhost
3. 查看"数据库"节点
4. 应该能看到 `StockAnalysisDB` 数据库

### 方法 3：查看日志

如果数据库初始化失败，会在调试输出中显示错误信息（`System.Diagnostics.Debug.WriteLine`）

---

## 🛠️ 常见问题

### Q: 数据库没有创建？

**可能原因**：
1. SQL Server 服务没有运行
2. 连接字符串配置错误
3. 没有创建数据库的权限

**解决方法**：
- 检查 SQL Server 服务是否启动
- 检查连接字符串是否正确
- 确保 SQL Server 身份验证已启用（如果使用 sa 账号）

### Q: 如何备份数据库？

**方法 1：使用 SSMS**
1. 右键点击数据库 → 任务 → 备份

**方法 2：使用 SQL 命令**
```sql
BACKUP DATABASE StockAnalysisDB 
TO DISK = 'C:\Backup\StockAnalysisDB.bak';
```

### Q: 如何重置/删除数据库？

**使用 SQL 命令**：
```sql
DROP DATABASE StockAnalysisDB;
```

程序下次启动时会自动重新创建。

---

## 📝 总结

- ✅ **数据库会自动创建**：首次运行程序时自动创建
- 📍 **保存位置**：SQL Server 默认数据目录
- 🔧 **需要配置**：修改连接字符串中的密码
- 📊 **包含3个表**：Favorites、RecentStocks、StockData
- 🔄 **自动初始化**：无需手动创建数据库或表

---

**提示**：如果不想使用 SQL Server，可以修改代码使用 SQLite 或其他数据库。

